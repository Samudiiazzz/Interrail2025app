<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interrail 2025: Itinerario Móvil</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --text-primary: #EAEAEA;
            --text-secondary: #a1a1aa;
            --accent-indigo: #4f46e5;
            --accent-indigo-hover: #6366f1;
            --accent-yellow: #facc15;
            --border-color: #333;
        }
        html, body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        h1, h2, h3 { font-weight: 700; }
        h1 { font-size: 2.25rem; line-height: 2.5rem; }
        h2 { font-size: 1.75rem; line-height: 2rem; }
        h3 { font-size: 1.25rem; line-height: 1.75rem; }
        p, label, span { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        header, footer, .component-bg {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .soft-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25) !important;
        }
        #progress-container {
            background-color: #2a2a2e;
            border-radius: 99px;
            overflow: hidden;
            height: 10px;
            margin: 1rem 0;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-yellow);
            transition: width 0.5s ease-in-out;
        }
        .primary-button {
            background-color: var(--accent-indigo) !important;
            color: var(--text-primary) !important;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
        }
        .primary-button:hover {
            background-color: var(--accent-indigo-hover) !important;
        }
        .primary-button:active {
            transform: scale(0.96);
        }
        .day-button {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .day-button:hover {
            background-color: var(--accent-indigo-hover);
            border-color: var(--accent-indigo-hover);
            color: white;
        }
        .day-button.active {
            background-color: var(--accent-yellow) !important;
            color: var(--bg-primary) !important;
            font-weight: 700;
            border-color: var(--accent-yellow) !important;
        }
        #day-view .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        #day-view .activity-icon {
            flex-shrink: 0;
            color: var(--accent-indigo-hover);
            width: 2rem;
            height: 2rem;
            margin-top: 0.125rem;
        }
        #day-view .activity-content p {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        #day-view .activity-content ul {
            list-style: disc;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
            color: var(--text-secondary);
        }
        #calendar-view .activity-card {
            background-color: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 1rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #calendar-view .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        #calendar-view .day-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-yellow);
        }
        .form-input, .form-textarea {
            background-color: var(--bg-primary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            width: 100%;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-indigo-hover) !important;
            box-shadow: 0 0 0 2px var(--accent-indigo);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        #mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            z-index: 100;
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #mobile-menu.open {
            left: 0;
        }
        #mobile-menu-content {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .view-section {
            transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
        }
        .hidden {
            display: block !important;
            opacity: 0;
            transform: scale(0.97);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        .visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            position: static;
        }
        #toast-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        .toast {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            animation: toast-in 0.3s ease forwards;
        }
        .toast.toast-out {
            animation: toast-out 0.3s ease forwards;
        }
        @keyframes toast-in {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toast-out {
            to { opacity: 0; transform: translateY(20px); }
        }
        @media (max-width: 767px) {
            #desktop-sidebar {
                display: none;
            }
        }
        @media (min-width: 768px) {
            #mobile-hamburger {
                display: none;
            }
            #mobile-menu {
                display: none !important;
            }
            main {
                 display: flex;
                 gap: 1.5rem;
            }
            #desktop-sidebar {
                width: 25%;
                min-width: 280px;
            }
            #main-content {
                width: 75%;
            }
        }
        .primary-button.bg-green-600,
        #edit-day-button,
        #mobile-edit-day-button {
            background-color: #CD5C5C !important;
            border: none;
        }
        .primary-button.bg-green-600:hover,
        #edit-day-button:hover,
        #mobile-edit-day-button:hover {
            background-color: #FF8C8C !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <header class="p-4 component-bg">
        <h1 class="text-2xl font-bold text-center">Interrail 2025</h1>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </header>
    <main class="p-4">
        <button id="mobile-hamburger" class="md:hidden fixed top-4 right-4 z-50 p-2 rounded-full bg-indigo-600">
            <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <aside id="desktop-sidebar" class="component-bg p-4 rounded-lg soft-shadow">
            <h2 class="text-xl font-semibold mb-4">Días del Viaje</h2>
            <div class="space-y-2 mb-4">
                 <button id="toggle-view-button" class="primary-button w-full">Ver Calendario</button>
                 <button id="edit-day-button" class="primary-button w-full bg-green-600 hover:bg-green-500">Editar Día</button>
            </div>
            <div id="day-navigation" class="space-y-1"></div>
        </aside>
        <nav id="mobile-menu">
            <div id="mobile-menu-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Navegación</h2>
                    <button id="close-mobile-menu" class="p-2">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="space-y-2 mb-4">
                     <button id="mobile-toggle-view-button" class="primary-button w-full">Ver Calendario</button>
                     <button id="mobile-edit-day-button" class="primary-button w-full bg-green-600 hover:bg-green-500">Editar Día</button>
                </div>
                <div id="mobile-day-navigation" class="space-y-1"></div>
            </div>
        </nav>
        <section id="main-content" class="component-bg p-4 rounded-lg soft-shadow relative overflow-hidden">
            <div id="day-view" class="view-section visible">
                <h2 id="day-title" class="text-3xl font-bold mb-1">Selecciona un día</h2>
                <h3 id="day-location" class="text-xl font-semibold text-indigo-400 mb-6">...</h3>
                <div class="space-y-4">
                    <div class="activity-item">
                        <svg class="activity-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707.707M6.343 18.364l-.707-.707m12.728 0l-.707.707M6.343 5.636l-.707-.707m12.728 0l.707-.707M5.636 5.636l.707-.707M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <div class="activity-content">
                           <p id="activity-morning">Detalles de la mañana...</p>
                           <ul id="morning-details"></ul>
                        </div>
                    </div>
                     <div class="activity-item">
                        <svg class="activity-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        <div class="activity-content">
                           <p id="activity-afternoon">Detalles de la tarde...</p>
                           <ul id="afternoon-details"></ul>
                        </div>
                    </div>
                     <div class="activity-item">
                        <svg class="activity-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <div class="activity-content">
                           <p id="activity-night">Detalles de la noche...</p>
                           <ul id="night-details"></ul>
                        </div>
                    </div>
                     <div class="activity-item">
                        <svg class="activity-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <div class="activity-content">
                           <p id="day-sleep">Alojamiento...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="calendar-view" class="view-section hidden">
                <h2 class="text-2xl font-bold text-center mb-4">Calendario del Viaje</h2>
                <div id="activity-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="edit-day-form" class="view-section hidden">
                <h2 class="text-2xl font-bold mb-4">Editar Día</h2>
                <div class="space-y-4">
                    <div>
                        <label class="form-label" for="edit-location">Ubicación:</label>
                        <input class="form-input" id="edit-location" type="text" />
                    </div>
                    <div>
                        <label class="form-label" for="edit-morning-activity">Actividad Mañana:</label>
                        <textarea class="form-textarea" id="edit-morning-activity" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="form-label" for="edit-afternoon-activity">Actividad Tarde:</label>
                        <textarea class="form-textarea" id="edit-afternoon-activity" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="form-label" for="edit-night-activity">Actividad Noche:</label>
                        <textarea class="form-textarea" id="edit-night-activity" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="form-label" for="edit-sleep">Alojamiento:</label>
                        <input class="form-input" id="edit-sleep" type="text" />
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancel-edit-button" class="primary-button bg-red-600 hover:bg-red-500">Cancelar</button>
                        <button id="save-day-button" class="primary-button bg-green-600 hover:bg-green-500">Guardar</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer class="text-center p-4 mt-4 text-sm text-gray-400 component-bg">
        <p>&copy; 2025 Interrail. Todos los derechos reservados.</p>
    </footer>
    <div id="toast-container"></div>
    <script>
        let itinerary = [];
        let selectedDayIdx = 0;
        // --- Cargar datos reales desde el backend ---
        async function cargarItinerario() {
            try {
                const res = await fetch("/api/leer");
                const data = await res.json();
                if (data.error) {
                    showToast("Error al cargar el itinerario: " + data.error);
                    itinerary = [];
                } else if (data.itinerary?.length) {
                    itinerary = data.itinerary;
                    itinerary.forEach(day => {
                        if (typeof day.startDate === 'string') {
                            day.startDate = new Date(day.startDate);
                        }
                    });
                } else {
                    itinerary = [];
                }
                renderNavigation();
                showDayDetails(0);
            } catch (error) {
                showToast("Error cargando itinerario: " + error.message);
                itinerary = [];
                renderNavigation();
                showDayDetails(0);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            cargarItinerario();
            setupEventListeners();
        });
        function renderNavigation() {
            const dayNav = document.getElementById('day-navigation');
            const mobileDayNav = document.getElementById('mobile-day-navigation');
            dayNav.innerHTML = '';
            mobileDayNav.innerHTML = '';
            let currentPart = "";
            itinerary.forEach((day, index) => {
                if (day.part !== currentPart) {
                    currentPart = day.part;
                    const partTitle = document.createElement('h3');
                    partTitle.textContent = currentPart;
                    partTitle.className = 'font-semibold text-indigo-400 mt-3 mb-1 px-1';
                    dayNav.appendChild(partTitle);
                    mobileDayNav.appendChild(partTitle.cloneNode(true));
                }
                const button = document.createElement('button');
                button.textContent = `Día ${day.day}: ${day.city}`;
                button.className = 'day-button';
                button.dataset.dayIndex = index;
                const desktopButton = button.cloneNode(true);
                desktopButton.addEventListener('click', () => showDayDetails(index));
                dayNav.appendChild(desktopButton);
                const mobileButton = button.cloneNode(true);
                mobileButton.addEventListener('click', () => {
                    showDayDetails(index);
                    closeMobileMenu();
                });
                mobileDayNav.appendChild(mobileButton);
            });
        }
        function updateActiveButton(idx) {
            document.querySelectorAll('.day-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.dayIndex == idx);
            });
        }
        function updateProgressBar(idx) {
            const progress = itinerary.length ? ((idx + 1) / itinerary.length) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        function showDayDetails(idx) {
            selectedDayIdx = idx;
            const day = itinerary[idx];
            if (!day) return;
            document.getElementById('day-title').textContent = `Día ${day.day}`;
            document.getElementById('day-location').textContent = day.city || '';
            document.getElementById('activity-morning').textContent = day.activities?.[0] || 'Sin actividad';
            document.getElementById('activity-afternoon').textContent = day.activities?.[1] || 'Sin actividad';
            document.getElementById('activity-night').textContent = day.activities?.[2] || 'Sin actividad';
            document.getElementById('day-sleep').textContent = day.sleep || 'Sin definir';
            updateActiveButton(idx);
            updateProgressBar(idx);
            switchView('day-view');
        }
        function showCalendarView() {
            const container = document.getElementById('activity-cards-container');
            container.innerHTML = '';
            itinerary.forEach((day, index) => {
                const card = document.createElement('div');
                card.className = 'activity-card soft-shadow cursor-pointer';
                card.innerHTML = `
                    <div class="day-number">${day.startDate instanceof Date ? day.startDate.getDate() : ''}</div>
                    <div class="font-semibold text-lg">${day.city}</div>
                    <p class="text-sm text-gray-400">${day.activities?.[0] || ''}</p>
                `;
                card.addEventListener('click', () => showDayDetails(index));
                container.appendChild(card);
            });
            switchView('calendar-view');
        }
        function showEditDayForm(idx) {
            const day = itinerary[idx];
            if (!day) return;
            selectedDayIdx = idx;
            document.getElementById('edit-location').value = day.city || '';
            document.getElementById('edit-morning-activity').value = day.activities?.[0] || '';
            document.getElementById('edit-afternoon-activity').value = day.activities?.[1] || '';
            document.getElementById('edit-night-activity').value = day.activities?.[2] || '';
            document.getElementById('edit-sleep').value = day.sleep || '';
            switchView('edit-day-form');
        }
        function switchView(viewIdToShow) {
            document.querySelectorAll('.view-section').forEach(section => {
                if (section.id === viewIdToShow) {
                    section.classList.remove('hidden');
                    section.classList.add('visible');
                } else {
                    section.classList.remove('visible');
                    section.classList.add('hidden');
                }
            });
            const isCalendar = viewIdToShow === 'calendar-view';
            document.getElementById('toggle-view-button').textContent = isCalendar ? "Ver Detalles del Día" : "Ver Calendario";
            document.getElementById('mobile-toggle-view-button').textContent = isCalendar ? "Ver Detalles del Día" : "Ver Calendario";
        }
        async function saveDayChanges() {
            const day = itinerary[selectedDayIdx];
            day.city = document.getElementById('edit-location').value;
            day.activities = [
                document.getElementById('edit-morning-activity').value,
                document.getElementById('edit-afternoon-activity').value,
                document.getElementById('edit-night-activity').value
            ];
            day.sleep = document.getElementById('edit-sleep').value;
            // Prepara el array para guardar (con startDate en string ISO)
            const itineraryToSend = itinerary.map(day => ({
                ...day,
                startDate: day.startDate instanceof Date ? day.startDate.toISOString().slice(0, 10) : day.startDate,
                activities: Array.isArray(day.activities) ? day.activities : ['', '', ''],
                city: day.city ?? '',
                part: day.part ?? '',
                day: day.day ?? (itinerary.indexOf(day) + 1),
                sleep: day.sleep ?? ''
            }));
            if (!Array.isArray(itineraryToSend) || !itineraryToSend.length) {
                showToast('No hay datos para guardar');
                return;
            }
            try {
                const res = await fetch('/api/guardar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itinerario: itineraryToSend })
                });
                const data = await res.json();
                if (data.ok) {
                    showToast('Día guardado correctamente');
                    await cargarItinerario();
                    showDayDetails(selectedDayIdx);
                } else {
                    showToast('Error al guardar: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                showToast('Error de red al guardar: ' + e.message);
            }
        }
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 2500);
        }
        function openMobileMenu() { document.getElementById('mobile-menu').classList.add('open'); }
        function closeMobileMenu() { document.getElementById('mobile-menu').classList.remove('open'); }
        function setupEventListeners() {
            document.getElementById('mobile-hamburger').addEventListener('click', openMobileMenu);
            document.getElementById('close-mobile-menu').addEventListener('click', closeMobileMenu);
            document.getElementById('toggle-view-button').addEventListener('click', () => {
                const isDayViewVisible = document.getElementById('day-view').classList.contains('visible');
                isDayViewVisible ? showCalendarView() : showDayDetails(selectedDayIdx);
            });
            document.getElementById('mobile-toggle-view-button').addEventListener('click', () => {
                const isDayViewVisible = document.getElementById('day-view').classList.contains('visible');
                isDayViewVisible ? showCalendarView() : showDayDetails(selectedDayIdx);
                closeMobileMenu();
            });
            document.getElementById('edit-day-button').addEventListener('click', () => showEditDayForm(selectedDayIdx));
            document.getElementById('mobile-edit-day-button').addEventListener('click', () => {
                showEditDayForm(selectedDayIdx);
                closeMobileMenu();
            });
            document.getElementById('save-day-button').addEventListener('click', saveDayChanges);
            document.getElementById('cancel-edit-button').addEventListener('click', () => showDayDetails(selectedDayIdx));
        }
        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('fetch', event => {
                    // Placeholder service worker
                });
            `;
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl).then(() => {
                console.log('Dummy Service Worker registered.');
            }).catch(err => {
                console.error('Dummy Service Worker registration failed:', err);
            });
        }
    </script>
</body>
</html>
